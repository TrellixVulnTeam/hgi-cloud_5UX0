{
  "variables": {
    "os_release": "",
    "programme": "",
    "env": "",
    "source_image_name": "",
    "network_id": "",
    "role_name": "base",
    "role_version": "0.0.0"
  },
  "builders": [
    {
      "type": "openstack",
      "user_data_file": "scripts/user_data.sh",
      "ssh_username": "ubuntu",
      "ssh_keypair_name": "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-keypair-mercury",
      "ssh_private_key_file": "~/.ssh/id_rsa",
      "source_image_filter": {
        "filters": {
          "name": "{{user `source_image_name`}}",
          "owner": "bd69a555635247bb94c23e02542c50ef",
          "visibility": "public"
        },
        "most_recent": true
      },
      "networks": ["{{user `network_id`}}"],
      "image_name": "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-image-packer-{{user `role_name`}}-{{user `role_version`}}",
      "instance_name": "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-instance-packer-{{user `role_name`}}-{{user `role_version`}}",
      "floating_ip_network": "public",
      "security_groups": [
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-ping",
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-ssh",
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-tcp-local",
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-udp-local"
      ],
      "use_blockstorage_volume": true,
      "volume_name": "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-volume-packer-{{user `role_name`}}-{{user `role_version`}}",
      "volume_size": 32,
      "flavor": "o2.medium"
    }
  ],
  "provisioners" : [
    {
      "type": "shell",
      "execute_command": "{{.Vars}} sudo -E bash '{{.Path}}'",
      "script": "scripts/setup.sh"
    },
    {
      "type": "ansible-local",
      "playbook_dir": "../ansible",
      "playbook_file": "../ansible/image.yml",
      "role_paths": [ "../ansible/roles" ],
      "extra_arguments": [ "--extra-vars \"role_name={{user `role_name`}} role_version={{user `role_version`}}\"" ],
      "staging_directory": "/opt/sanger.ac.uk/ansible",
      "clean_staging_directory": false
    },
    {
      "type": "shell",
      "script": "scripts/validate.sh"
    },
    {
      "type": "shell",
      "execute_command": "{{.Vars}} sudo -E bash '{{.Path}}'",
      "script": "scripts/cleanup.sh"
    }
  ],
  "post-processors": [
    {
      "type": "checksum",
      "checksum_types": ["md5", "sha512"],
      "output": "packer_{{.BuildName}}_{{.BuilderType}}_{{.ChecksumType}}.checksum"
    },
    {
      "type": "manifest",
      "output": "packer-manifest.json"
    }
  ]
}
