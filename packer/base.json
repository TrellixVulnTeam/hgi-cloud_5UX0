{
  "variables": {
    "os_release": "",
    "programme": "",
    "env": "",
    "role_name": "base",
    "role_version": "0.0.0"
  },
  "builders": [
    {
      "type": "openstack",
      "ssh_username": "ubuntu",
      "source_image": "{{user `source_image_id`}}",
      "networks": ["{{user `network_id`}}"],
      "image_name": "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-image-{{user `role_name`}}-{{user `role_version`}}",
      "instance_name": "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-image-{{user `role_name`}}-{{user `role_version`}}",
      "floating_ip_network": "public",
      "security_groups": [
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-ping",
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-ssh",
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-tcp-local",
        "uk-sanger-internal-openstack-{{user `os_release`}}-{{user `programme`}}-{{user `env`}}-secgroup-udp-local"
      ],
      "flavor": "o2.small"
    }
  ],
  "provisioners" : [
    {
      "type": "shell",
      "execute_command": "{{.Vars}} sudo -E bash '{{.Path}}'",
      "script": "scripts/setup.sh"
    },
    {
      "type": "ansible-local",
      "playbook_file": "ansible/main.yml"
    },
    {
      "type": "shell",
      "script": "scripts/validate.sh"
    },
    {
      "type": "shell",
      "execute_command": "{{.Vars}} sudo -E bash '{{.Path}}'",
      "script": "scripts/cleanup.sh"
    }
  ],
  "post-processors": [
    {
      "type": "checksum",
      "checksum_types": ["md5", "sha512"],
      "output": "packer_{{.BuildName}}_{{.BuilderType}}_{{.ChecksumType}}.checksum"
    },
    {
      "type": "manifest",
      "output": "packer-manifest.json"
    }
  ]
}
