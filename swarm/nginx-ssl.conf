
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    resolver 127.0.0.11 ipv6=off;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }


    server {

        listen 8080;
        server_name apps.hgi.sanger.ac.uk;
        ssl_certificate /etc/ssl/certs/www.example.com.crt;
        ssl_certificate_key /etc/ssl/private/www.example.com.key;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;
        keepalive_timeout   70;


        # intermediate configuration. tweak to your needs.
  
        ssl_prefer_server_ciphers on;

        # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
        add_header Strict-Transport-Security max-age=15768000;

        # OCSP Stapling ---
        # fetch OCSP records from URL in ssl_certificate and cache them
        ssl_stapling on;
        ssl_stapling_verify on;

        ## verify chain of trust of OCSP response using Root CA and Intermediate certs
        ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;
        resolver <IP DNS resolver>;


        location  / {

            auth_request /auth-proxy;
            # redirect 401 to login form
            # Comment them out if using HTTP basic authentication.
            # or authentication popup won't show
            error_page 401 =200 /login;
            proxy_pass http://services.hgi.sanger.ac.uk;
        }

       


        location /login {
            proxy_pass http://login-page:9000/login;
            # Login service returns a redirect to the original URI
            # and sets the cookie for the ldap-auth daemon
            proxy_set_header X-Target $request_uri;
        }

        location  /auth-proxy {
            internal;

            # The ldap-auth daemon listens on port 8888, as set
            # in nginx-ldap-auth-daemon.py.
            # Change the IP address if the daemon is not running on
            # the same host as NGINX/NGINX Plus.
            
            proxy_pass http://nginx-ldap-auth-daemon:8888/;

            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            # proxy_cache auth_cache;
            # proxy_cache_valid 200 10m;

            # The following directive adds the cookie to the cache key
            # proxy_cache_key "$http_authorization$cookie_nginxauth";

            # As implemented in nginx-ldap-auth-daemon.py, the ldap-auth daemon
            # communicates with a LDAP server, passing in the following
            # parameters to specify which user account to authenticate. To
            # eliminate the need to modify the Python code, this file contains
            # 'proxy_set_header' directives that set the values of the
            # parameters. Set or change them as instructed in the comments.
            #
            #    Parameter      Proxy header
            #    -----------    ----------------
            #    url            X-Ldap-URL
            #    basedn         X-Ldap-BaseDN
            #    cookiename     X-CookieName
            #    template       X-Ldap-Template

            proxy_set_header X-Ldap-URL      "ldap://ldap-ro.internal.sanger.ac.uk:389";
            proxy_set_header X-Ldap-BaseDN   "ou=people,dc=sanger,dc=ac,dc=uk";
            proxy_set_header X-CookieName "nginxauth";
            proxy_set_header Cookie nginxauth=$cookie_nginxauth;
            proxy_set_header X-Ldap-Template "(uid=%(username)s)";

        }

        location /treeserve {
            auth_request /auth-proxy;
            # redirect 401 to login form
            # Comment them out if using HTTP basic authentication.
            # or authentication popup won't show
            error_page 401 =200 /login;
            auth_request_set $user $upstream_http_x_forwarded_user;
            proxy_set_header X-Forwarded-User $user
            proxy_set_header Set-Cookie "";
            proxy_pass  http://172.27.83.232/;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

        }

        location  /weaver {
            auth_request /auth-proxy;
            # redirect 401 to login form
            # Comment them out if using HTTP basic authentication.
            # or authentication popup won't show
            error_page 401 =200 /login;
            proxy_pass http://weaver:3838;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

        }


        location  /spaceman {
            auth_request /auth-proxy;
            # redirect 401 to login form
            # Comment them out if using HTTP basic authentication.
            # or authentication popup won't show
            error_page 401 =200 /login;
            proxy_pass http://weaver:3838/spaceman;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

        }

        location  /cluster-report/api {
            proxy_pass http://backend:3000/api;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            add_header Cache-Control "no-store, no-cache, must-revalidate, post-check=0, pre-check=0";
        }


        location  /cluster-report/ {
            auth_request /auth-proxy;
            # redirect 401 to login form
            # Comment them out if using HTTP basic authentication.
            # or authentication popup won't show
            error_page 401 =200 /login;
            proxy_pass http://frontend:8080/cluster-report/;
            proxy_set_header Host            $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            add_header Cache-Control "no-store, no-cache, must-revalidate, post-check=0, pre-check=0";
        }

    }



}



 
